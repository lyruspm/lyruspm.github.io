<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Manager</title>

<style>
/* =========================
   THEME TOKENS
========================= */
:root{
    --bg-main:#0f1117;
    --bg-card:#1a1d26;
    --bg-accent:#232734;

    --accent:#5aa2ff;
    --danger:#ff5a7a;

    --radius:14px;

    --space-xs:6px;
    --space-sm:10px;
    --space-md:16px;
    --space-lg:24px;

    --transition:0.18s ease;
}

/* =========================
   BASE
========================= */
*{
    box-sizing:border-box;
}

body{
    background:var(--bg-main);
    color:white;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    padding:var(--space-lg);
    line-height:1.4;
}

/* =========================
   CARD LAYOUT (Optional)
========================= */
.card{
    background:var(--bg-card);
    border-radius:var(--radius);
    padding:var(--space-lg);
}

/* =========================
   INPUTS / TEXTAREAS / SELECT
========================= */
input,
textarea,
select{
    width:100%;
    padding:14px;
    margin-bottom:var(--space-md);
    border-radius:var(--radius);
    border:none;
    background:var(--bg-card);
    color:white;
    font-size:14px;

    transition:var(--transition);
    outline:none;
}

/* Focus glow */
input:focus,
textarea:focus,
select:focus{
    background:var(--bg-accent);
    box-shadow:0 0 0 2px var(--accent);
}

/* Textarea usability */
textarea{
    resize:vertical;
    min-height:120px;
}

/* Select reset */
select{
    appearance:none;
    cursor:pointer;
}

/* =========================
   BUTTON SYSTEM
========================= */
button{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    margin-bottom:12px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;

    transition:var(--transition);
}

/* Variants */
.btn-primary{
    background:var(--accent);
}

.btn-danger{
    background:var(--danger);
}

/* Hover / Active */
button:hover{
    transform:translateY(-1px);
    filter:brightness(1.05);
}

button:active{
    transform:translateY(0);
    filter:brightness(.95);
}

/* =========================
   AVATAR PREVIEW
========================= */
.avatarPreview{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    background:var(--bg-accent);
    display:block;
    margin:0 auto var(--space-md) auto;
}

/* =========================
   CANVAS EDITOR
========================= */
#editorContainer{
    display:none;
    margin-bottom:var(--space-lg);
}

canvas{
    width:260px;
    height:260px;
    border-radius:50%;
    display:block;
    margin:0 auto var(--space-sm) auto;
    background:#000;
}

#zoomSlider{
    width:100%;
    margin-bottom:var(--space-sm);
}

/* =========================
   UTILITY HELPERS
========================= */
.center{
    display:flex;
    justify-content:center;
    align-items:center;
}

.stack > * + *{
    margin-top:var(--space-md);
}

.hidden{
    display:none !important;
}

/* =========================
   MOBILE TWEAKS
========================= */
@media (max-width:480px){
    body{
        padding:var(--space-md);
    }

    canvas{
        width:220px;
        height:220px;
    }

    .avatarPreview{
        width:120px;
        height:120px;
    }
}

/* Base button */
.btn{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    transition:0.18s ease;
}

/* SAVE */
.saveBtn{
    background:var(--accent);
    color:white;
}

.saveBtn:hover{
    filter:brightness(1.1);
}

.saveBtn:active{
    filter:brightness(.9);
}


/* DELETE */
.deleteBtn{
    background:var(--danger);
    color:white;
}

.deleteBtn:hover{
    filter:brightness(1.1);
}

.deleteBtn:active{
    filter:brightness(.9);
}


</style>
</head>

<body>

<h1>Edit Character</h1>

<img id="avatarPreview" class="avatarPreview">

<input type="file" id="charImage" accept="image/*">

<div id="editorContainer">
    <canvas id="imageCanvas" width="300" height="300"></canvas>
    <input type="range" id="zoomSlider" min="0.5" max="3" step="0.01" value="1">
    <button type="button" id="useImageBtn">Use Image</button>
</div>

<input id="charName" placeholder="Name">
<textarea id="charDesc" placeholder="Description"></textarea>
<input id="charTags" placeholder="Tags">
<input id="charFolder" placeholder="Folder">

<h2 style="margin-top:20px;">Life Timeline</h2>

<input type="date" id="charBirthDate" placeholder="Birth Date">
<input type="date" id="charDeathDate" placeholder="Death Date">


<div id="autoStats" style="
background:var(--bg-card);
padding:14px;
border-radius:var(--radius);
margin-bottom:16px;
font-size:14px;
color:#9aa3b2;
">
</div>


<h2 style="margin-top:20px;">Custom Fields</h2>

<div id="customFieldsList"></div>

<button type="button" id="addCustomFieldBtn">
+ Add Custom Field
</button>



<h2 style="margin-top:20px;">Lore Metadata</h2>

<input id="charSpecies" placeholder="Species">
<input id="charFaction" placeholder="Faction">
<input id="charOrigin" placeholder="Origin World / Location">

<select id="charAlignment">
    <option value="">Alignment</option>
    <option>Hero</option>
    <option>Neutral</option>
    <option>Villain</option>
    <option>Anti-Hero</option>
    <option>Anti-Villain</option>
</select>

<h2 style="margin-top:20px;">Relationships</h2>

<div id="relationshipList"></div>

<button type="button" id="addRelationshipBtn">
+ Add Relationship
</button>

<button class="saveBtn" id="saveBtn">Save Changes</button>
<button class="btn deleteBtn" id="deleteCharacterBtn">
    Delete Character
</button>




<!-- JAVA SCRIPT -->


<script>
/* ===== LOAD CHARACTER ===== */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let index = localStorage.getItem("editingCharacterIndex");
let char = characters[index];
let savedImageData = char?.image || null;
customFields: [
  {
    id: "unique-id",
    label: "Magic Affinity",
    type: "text", // text | longtext | number | boolean | select
    value: "",
    options: [] // only used if type === "select"
  }
]


/* ===== ELEMENTS ===== */
const avatarPreview = document.getElementById("avatarPreview");
const fileInput = document.getElementById("charImage");
const editor = document.getElementById("editorContainer");
const canvas = document.getElementById("imageCanvas");
const ctx = canvas.getContext("2d");
const zoomSlider = document.getElementById("zoomSlider");
const useBtn = document.getElementById("useImageBtn");
const birthInput = document.getElementById("charBirthDate");
const deathInput = document.getElementById("charDeathDate");
const autoStats = document.getElementById("autoStats");

const speciesInput = document.getElementById("charSpecies");
const factionInput = document.getElementById("charFaction");
const originInput = document.getElementById("charOrigin");
const alignmentInput = document.getElementById("charAlignment");

const relationshipList = document.getElementById("relationshipList");
const addRelationshipBtn = document.getElementById("addRelationshipBtn");
const deleteBtn = document.getElementById("deleteCharacterBtn");
const customFieldsList = document.getElementById("customFieldsList");
const addCustomFieldBtn = document.getElementById("addCustomFieldBtn");




let relationships = char?.relationships || [];
let customFields = char?.customFields || [];





/* ===== LOAD DATA INTO FORM ===== */
if(char){
    charName.value = char.name || "";
    charDesc.value = char.desc || "";
    charTags.value = char.tags || "";
    charFolder.value = char.folder || "";
    birthInput.value = char.birthDate || "";
deathInput.value = char.deathDate || "";
speciesInput.value = char.species || "";
factionInput.value = char.faction || "";
originInput.value = char.origin || "";
alignmentInput.value = char.alignment || "";



    if(char.image){
        avatarPreview.src = char.image;
    }
}

/* ===== IMAGE EDITOR ===== */
let img = new Image();
let scale = 1;
let posX = 0;
let posY = 0;
let dragging = false;
let startX = 0;
let startY = 0;

fileInput.addEventListener("change", function(){
    const file = fileInput.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function(e){
        img.onload = function(){
            editor.style.display = "block";
            scale = Math.max(
    canvas.width / img.width,
    canvas.height / img.height
);
            posX = (canvas.width - img.width * scale) / 2;
posY = (canvas.height - img.height * scale) / 2;
     
        };
        img.src = e.target.result;
    };

    reader.readAsDataURL(file);
});

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.beginPath();
    ctx.arc(150,150,150,0,Math.PI*2);
    ctx.clip();

    ctx.drawImage(img, posX, posY, img.width*scale, img.height*scale);
    ctx.restore();
}

canvas.addEventListener("mousedown", startDrag);
canvas.addEventListener("touchstart", startDrag);

function startDrag(e){
    dragging = true;

    let rect = canvas.getBoundingClientRect();

    startX = e.touches
        ? e.touches[0].clientX - rect.left
        : e.clientX - rect.left;

    startY = e.touches
        ? e.touches[0].clientY - rect.top
        : e.clientY - rect.top;
}


canvas.addEventListener("mousemove", dragMove);
canvas.addEventListener("touchmove", dragMove);

function dragMove(e){
    if(!dragging) return;

    let rect = canvas.getBoundingClientRect();

    let x = e.touches
        ? e.touches[0].clientX - rect.left
        : e.clientX - rect.left;

    let y = e.touches
        ? e.touches[0].clientY - rect.top
        : e.clientY - rect.top;

    posX += x - startX;
    posY += y - startY;

    startX = x;
    startY = y;

    clampPosition();
    draw();
}

canvas.addEventListener("mouseup", ()=> dragging=false);
canvas.addEventListener("touchend", ()=> dragging=false);
canvas.addEventListener("touchmove", e=>{
    if(dragging) e.preventDefault();
}, { passive:false });


zoomSlider.addEventListener("input", ()=>{
    scale = parseFloat(zoomSlider.value);
    draw();
});

useBtn.addEventListener("click", ()=>{
    savedImageData = canvas.toDataURL("image/png");
    avatarPreview.src = savedImageData;
    editor.style.display = "none";
});




// DRAG BOUNDARIES

function clampPosition(){
    const imgW = img.width * scale;
    const imgH = img.height * scale;

    // Prevent empty space inside circle
    const minX = canvas.width - imgW;
    const minY = canvas.height - imgH;

    posX = Math.min(0, Math.max(minX, posX));
    posY = Math.min(0, Math.max(minY, posY));
}

/* BIRTH AND DEATH INPUT */

birthInput.addEventListener("input", updateAutoStats);
deathInput.addEventListener("input", updateAutoStats);


/* DATE AND DEATH */


function updateAutoStats(){

    const birth = birthInput.value ? new Date(birthInput.value) : null;
    const death = deathInput.value ? new Date(deathInput.value) : null;

    let status = "Alive";
    let age = "Unknown";

    if(birth){
        const endDate = death || new Date();

        age = Math.floor(
            (endDate - birth) / (1000 * 60 * 60 * 24 * 365.25)
        );
    }

    if(death){
        status = "Deceased";
    }

    autoStats.innerHTML = `
    Status: <b>${status}</b><br>
    Age: <b>${age}</b>
    `;

    return { status, age };
}

updateAutoStats();

/* ===== SAVE ===== */
saveBtn.onclick = () => {

    const auto = updateAutoStats();

    characters[index] = {
        name: charName.value,
        desc: charDesc.value,
        tags: charTags.value,
        folder: charFolder.value,
        image: savedImageData,

        birthDate: birthInput.value || null,
        deathDate: deathInput.value || null,

        status: auto.status,
        age: auto.age,
        species: speciesInput.value,
        faction: factionInput.value,
        origin: originInput.value,
        alignment: alignmentInput.value,
        relationships: relationships,
        customFields: customFields,



        
        
    };

    localStorage.setItem("characters", JSON.stringify(characters));
    window.location.href = "character.html";
};

/* ALIGNMENT */

function updateAlignmentStyle(){

    alignmentInput.classList.remove(
        "alignment-hero",
        "alignment-villain",
        "alignment-neutral",
        "alignment-anti-hero",
        "alignment-anti-villain"
    );

    const val = alignmentInput.value.toLowerCase();

    if(val === "hero") alignmentInput.classList.add("alignment-hero");
    if(val === "villain") alignmentInput.classList.add("alignment-villain");
    if(val === "neutral") alignmentInput.classList.add("alignment-neutral");
    if(val === "anti-hero") alignmentInput.classList.add("alignment-anti-hero");
    if(val === "anti-villain") alignmentInput.classList.add("alignment-anti-villain");
    alignmentInput.addEventListener("change", updateAlignmentStyle);
    updateAlignmentStyle();

}

/* ===== RELATIONSHIPS ===== */

addRelationshipBtn.addEventListener("click", ()=>{
    relationships.push({
        name:"",
        type:""
    });
    renderRelationships();
});

function renderRelationships(){

    relationshipList.innerHTML = "";

    relationships.forEach((rel, i)=>{

        const row = document.createElement("div");

        row.style.display = "flex";
        row.style.gap = "8px";
        row.style.marginBottom = "10px";

        row.innerHTML = `
        <input placeholder="Name"
            value="${rel.name || ""}"
            data-index="${i}"
            class="rel-name">

        <input placeholder="Type (Friend, Rival, etc)"
            value="${rel.type || ""}"
            data-index="${i}"
            class="rel-type">

        <button data-index="${i}" class="rel-delete" style="
            width:60px;
            background:var(--danger);
        ">X</button>
        `;

        relationshipList.appendChild(row);
    });

    bindRelationshipEvents();
}

function bindRelationshipEvents(){

    document.querySelectorAll(".rel-name").forEach(el=>{
        el.addEventListener("input", e=>{
            const i = e.target.dataset.index;
            relationships[i].name = e.target.value;
        });
    });

    document.querySelectorAll(".rel-type").forEach(el=>{
        el.addEventListener("input", e=>{
            const i = e.target.dataset.index;
            relationships[i].type = e.target.value;
        });
    });

    document.querySelectorAll(".rel-delete").forEach(btn=>{
        btn.addEventListener("click", e=>{
            const i = e.target.dataset.index;
            relationships.splice(i,1);
            renderRelationships();
        });
    });
}

renderRelationships();


/* =====================
    DELETE CHARACTERS
=========================*/
deleteBtn.addEventListener("click", () => {

    const confirmDelete = confirm(
        "Are you sure you want to delete this character? This cannot be undone."
    );

    if (!confirmDelete) return;

    // Remove character from array
    characters.splice(index, 1);

    // Save updated array
    localStorage.setItem("characters", JSON.stringify(characters));

    alert("Character deleted.");

    // Redirect back to list
    window.location.href = "character.html";
});

/* ============ FIELD BUTTON ============== */

addCustomFieldBtn.addEventListener("click", () => {

    customFields.push({
        id: crypto.randomUUID(),
        label: "",
        type: "text",
        value: "",
        options: []
    });

    renderCustomFields();
});


/* RENDERER */


function renderCustomFields(){

    customFieldsList.innerHTML = "";

    customFields.forEach((field, i) => {

        const wrapper = document.createElement("div");
        wrapper.style.background = "var(--bg-card)";
        wrapper.style.padding = "12px";
        wrapper.style.borderRadius = "var(--radius)";
        wrapper.style.marginBottom = "12px";

        wrapper.innerHTML = `
            <input 
                placeholder="Field Label"
                value="${field.label}"
                data-index="${i}"
                class="cf-label">

            <select data-index="${i}" class="cf-type">
                <option value="text" ${field.type==="text"?"selected":""}>Text</option>
                <option value="longtext" ${field.type==="longtext"?"selected":""}>Long Text</option>
                <option value="number" ${field.type==="number"?"selected":""}>Number</option>
                <option value="boolean" ${field.type==="boolean"?"selected":""}>True / False</option>
                <option value="select" ${field.type==="select"?"selected":""}>Dropdown</option>
            </select>

            <div class="cf-value-container" data-index="${i}"></div>

            <button data-index="${i}" class="cf-delete" style="
                margin-top:8px;
                background:var(--danger);
            ">Delete</button>
        `;

        customFieldsList.appendChild(wrapper);
    });

    bindCustomFieldEvents();
    renderCustomFieldValues();
}

function renderCustomFieldValues(){

    document.querySelectorAll(".cf-value-container").forEach(container => {

        const i = container.dataset.index;
        const field = customFields[i];

        container.innerHTML = "";

        if(field.type === "text"){
            container.innerHTML = `
                <input placeholder="Value"
                value="${field.value || ""}"
                data-index="${i}"
                class="cf-value">
            `;
        }

        if(field.type === "longtext"){
            container.innerHTML = `
                <textarea placeholder="Value"
                data-index="${i}"
                class="cf-value">${field.value || ""}</textarea>
            `;
        }

        if(field.type === "number"){
            container.innerHTML = `
                <input type="number"
                value="${field.value || ""}"
                data-index="${i}"
                class="cf-value">
            `;
        }

        if(field.type === "boolean"){
            container.innerHTML = `
                <label style="display:flex; gap:8px; align-items:center;">
                    <input type="checkbox"
                    ${field.value ? "checked" : ""}
                    data-index="${i}"
                    class="cf-value-bool">
                    True
                </label>
            `;
        }

        if(field.type === "select"){

            const optionsString = field.options?.join(", ") || "";

            container.innerHTML = `
                <input placeholder="Options (comma separated)"
                    value="${optionsString}"
                    data-index="${i}"
                    class="cf-options">

                <select data-index="${i}" class="cf-value-select">
                    ${field.options.map(opt =>
                        `<option ${opt===field.value?"selected":""}>${opt}</option>`
                    ).join("")}
                </select>
            `;
        }
    });
}

function bindCustomFieldEvents(){

    document.querySelectorAll(".cf-label").forEach(el=>{
        el.addEventListener("input", e=>{
            const i = e.target.dataset.index;
            customFields[i].label = e.target.value;
        });
    });

    document.querySelectorAll(".cf-type").forEach(el=>{
        el.addEventListener("change", e=>{
            const i = e.target.dataset.index;
            customFields[i].type = e.target.value;
            customFields[i].value = "";
            renderCustomFields();
        });
    });

    document.querySelectorAll(".cf-delete").forEach(btn=>{
        btn.addEventListener("click", e=>{
            const i = e.target.dataset.index;
            customFields.splice(i,1);
            renderCustomFields();
        });
    });

    document.querySelectorAll(".cf-value").forEach(el=>{
        el.addEventListener("input", e=>{
            const i = e.target.dataset.index;
            customFields[i].value = e.target.value;
        });
    });

    document.querySelectorAll(".cf-value-bool").forEach(el=>{
        el.addEventListener("change", e=>{
            const i = e.target.dataset.index;
            customFields[i].value = e.target.checked;
        });
    });

    document.querySelectorAll(".cf-options").forEach(el=>{
        el.addEventListener("input", e=>{
            const i = e.target.dataset.index;
            customFields[i].options = e.target.value
                .split(",")
                .map(o=>o.trim())
                .filter(o=>o);
            renderCustomFieldValues();
        });
    });

    document.querySelectorAll(".cf-value-select").forEach(el=>{
        el.addEventListener("change", e=>{
            const i = e.target.dataset.index;
            customFields[i].value = e.target.value;
        });
    });
}

renderCustomFields();


</script>

</body>
</html>
